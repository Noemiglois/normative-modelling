---
title: "Normative modeling in Schizophrenia - Analysis of the 308 regions parcellation"
author: "Noemi González Lois"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---


```{r setup I, include=F}
knitr::opts_chunk$set(
  include = TRUE,  
  echo=TRUE, 
  eval=TRUE, 
  warning=TRUE, 
  message = TRUE,
  cache = FALSE
)
```

### Packages and libraries

```{r, warning=F, message = F}

library("easypackages") # install.packages("easypackages")

# get a list of all the needed packages
list.of.packages <- c("viridis", "tidyverse", "MatchIt", "grid", "png", 
                      "gridExtra", "parallel", "nlme", "JMbayes", 
                      "BiocManager", "Biostrings", "lme4", "ggplot2", 
                      "Hmisc", "devtools", "longCombat", "neuroCombat", 
                      "tinytex", "knitr", "dplyr")

# load them all
libraries(list.of.packages)
ncores = detectCores() # Number of cores available in pc
rm(list.of.packages)
```



```{r, eval = FALSE, include = FALSE}
library(viridis)   # install.packages("viridis")
library(tidyverse) # install.packages("tidyverse")
library(MatchIt)
library(grid)
library(png)
library(gridExtra)
library(parallel)
library(nlme)
library(JMbayes)
# if (!requireNamespace("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("Biostrings")
library(BiocManager)
library(Biostrings)
library(lme4) # install.packages("lme4")
library(ggplot2)
library(Hmisc)
library('devtools') #install.packages("devtools")
library('longCombat') # install_github("jcbeer/longCombat")
library('neuroCombat') # install_github("jfortin1/CombatHarmonization/R/neuroCombat")
library(tinytex) #tinytex::install_tinytex()
ncores = detectCores() # Number of cores available in pc
 
# library(dplyr) # install.packages("dplyr")
#
# library(pbmcapply)
# 
# library(sets)
```

### Set working directory and load functions

```{r, warning=F, message = F}
setwd("/data_J/Scripts")
source("1_DataPreparation.R")
source("2_RegressionModel.R")
source("3_Statistics.R")
source("4_EDA.R")
```

# Data preparation

Options of DataPreparation function: 

* parc = "parc35" or "parc308" (whether to use the 34 regions parcellation or the 308 regions one)
* harmonization= "lC" or "nC" (whether to use lonCombat or NeuroCombat harmonization)
* match = T or F (whether to use match-it or not)

```{r, warning = F, message = F}
df_lC_NO_matched <- DataPreparation(parc = "parc308",
                                    harmonization = "lC",
                                    match = F)

df_lC_matched <- DataPreparation(parc = "parc308",
                                 harmonization = "lC",
                                 match = T)
```

\textcolor{red}{Warning}: Fewer control units than treated units; not all treated units will get a match.

Stack Overflow: This warning is because our treated group is larger than our control group (this happens in timepoint = 2). If you're doing 1:1 matching without replacement, all the control units will be used up before all the treated units get a match. **To remedy this, you need to match with replacement or think about whether you actually want to generalize to the control population and switch the labels on the treatment groups**. You can do this by creating a new variable, say notY, which is 1 - Y and then performing the same operations.

\textcolor{red}{The match in *sex variable* is not exact. Anyway, the match in \# patients, \# controls is done well (¿is it enough?)}

### NO MATCHED DATASET

|  NO MATCHED| timepoint 1| timepoint 2 | timepoint 3 |
| -----------|:----------:|:-----------:|:-----------:|
| # controls | 298        | 293         | 109         |
| # patients | 169        | 168         | 50          |


| Timepoint 1| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls | 131  | 167  |
| # patients |  38  | 131  |


| Timepoint 2| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls | 130  | 163  |
| # patients |  38  | 130  |

| Timepoint 3| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |  50  |  59  |
| # patients |   7  |  43  |

```{r, eval=FALSE, include=FALSE}
table(df_lC_NO_matched$dcode, df_lC_NO_matched$timepoint)

for (i in 1:3) {
  print(knitr::kable(table(dcode=df_lC_NO_matched$dcode, sex=df_lC_NO_matched$scode,
                           timepoint=df_lC_NO_matched$timepoint)[,,i]))
}
```


### MATCHED DATASET

Number of patients vs number of controls per timepoint is not exactly the same:


|  MATCHED   | timepoint 1| timepoint 2 | timepoint 3 |
| -----------|:----------:|:-----------:|:-----------:|
| # controls | 169        | 164         | 49          |
| # patients | 169        | 164         | 49          |

| Timepoint 1| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |  38  | 131  |
| # patients |  38  | 131  |


| Timepoint 2| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |  37  | 127  |
| # patients |  38  | 126  |


| Timepoint 3| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |   8  | 41   |
| # patients |   7  | 42   |

```{r, eval=FALSE, include=FALSE}

table(df_lC_matched$dcode, df_lC_matched$timepoint)

for (i in 1:3) {
  print(knitr::kable(table(dcode=df_lC_matched$dcode, sex=df_lC_matched$scode, 
                           timepoint=df_lC_matched$timepoint)[,,i]))
}
```

# Exploratory Data Analysis

Show relevant figures and analytics before and after data preparation. For example, age of controls vs age of patients in the raw df vs the match-it df:

## Matching ages:

```{r}
EDA_match_ages(df_lC_NO_matched,"NO match-it")

EDA_match_ages(df_lC_matched,"match-it")
```

# Linear Mixed Effects Model Regresion

Calling the *run_NormativeModel* function with different datasets. This will return the z scores (one for each region for each timepoint of each subject)

## NO Match-it dataframe (longCombat):

```{r}
Zs_NOmatch <- run_NormativeModel(df_lC_NO_matched,
                                 measure = "thickness",
                                 parc = "parc308",
                                 match = "NOmatch",
                                 harmonization = "lC")

```


## Match-it dataframe (longCombat):

```{r}
Zs_match <- run_NormativeModel(df_lC_matched,
                               measure = "thickness",
                               parc = "parc308",
                               match = "match",
                               harmonization = "lC")
```


## Match-it dataframe (Age*Diagnosis) BEFORE EXCLUDING DEVIANTS

```{r}
p_val <- run_AgeDiagnosisModel(df_lC_matched, measure = "thickness")

head(p_val)
```

```{r echo=FALSE, results='hold'}
cat("Without FDR correction:\n")
cat("Variable dcode is statistical significant for ",sum(p_val[,"dcode"]<0.05),"regions\n")
cat("Variable dcode_age is statistical significant for ",sum(p_val[,"dcode_age"]<0.05),"regions")
```

```{r}
p_val_FDR <- Apply_FDR_Correction(p_val)

head(p_val_FDR)
```

```{r echo=FALSE, results='hold'}
cat("With FDR correction:\n")
cat("Variable dcode is statistical significant for ", sum(p_val_FDR[,"dcode"]<0.05),"regions\n")
cat("Variable dcode_age is statistical significant for ",sum(p_val_FDR[,"dcode_age"]<0.05),"regions")
```

```{r}
# PLOT p-values
par(mfrow = c(2, 2), mai = c(0.9, 0.8, 0.2, 0.2))  # 2 rows and 2 columns
x1 <- p_val[,"dcode"]
x2 <- p_val_FDR[,"dcode"]
x3 <- p_val[,"dcode_age"]
x4 <- p_val_FDR[,"dcode_age"]

hist(x1, main="p-vals (dcode)", col="orange")
hist(x2, main="p-vals with FDR (dcode)", col="green")
hist(x3, main="p-vals (dcode_age)", col="orange")
hist(x4, main="p-vals with FDR (dcode_age)", col="green")
```


## Match-it dataframe (Age*Diagnosis) AFTER EXCLUDING DEVIANTS

```{r}
p_val <- run_AgeDiagnosisModel(df_lC_matched, 
                               measure = "thickness", 
                               Z = Zs_match, 
                               exclude_deviants = T )

head(p_val)
```

```{r echo=FALSE, results='hold'}
cat("Without FDR correction:\n")
cat("Variable dcode is statistical significant for ",sum(p_val[,"dcode"]<0.05),"regions\n")
cat("Variable dcode_age is statistical significant for ",sum(p_val[,"dcode_age"]<0.05),"regions")
```

```{r}
p_val_FDR <- Apply_FDR_Correction(p_val)

head(p_val_FDR)
```

```{r echo=FALSE, results='hold'}
cat("With FDR correction:\n")
cat("Variable dcode is statistical significant for ", sum(p_val_FDR[,"dcode"]<0.05),"regions\n")
cat("Variable dcode_age is statistical significant for ",sum(p_val_FDR[,"dcode_age"]<0.05),"regions")
```


```{r}
# PLOT p-values
par(mfrow = c(2, 2), mai = c(0.9, 0.8, 0.2, 0.2))  # 2 rows and 2 columns
x1 <- p_val[,"dcode"]
x2 <- p_val_FDR[,"dcode"]
x3 <- p_val[,"dcode_age"]
x4 <- p_val_FDR[,"dcode_age"]

hist(x1, main="p-vals (dcode)", col="orange")
hist(x2, main="p-vals with FDR (dcode)", col="green")
hist(x3, main="p-vals (dcode_age)", col="orange")
hist(x4, main="p-vals with FDR (dcode_age)", col="green")
```


<!-- # Analysis of z-scores and computation of global scores -->

<!-- The following tables represent, **in terms of samples**, the number of deviations ($|Z|>1.96$). It is calculated for each timepoint ($timepoint=1,2,3$) and differentiated between controls and subjects. -->

<!-- |     NO MATCHED     | timepoint 1   | timepoint 2   | timepoint 3 | -->
<!-- | ----------------   |:-----------:  |:-------------:|:-----------:| -->
<!-- | # total samples    |  143.528      |141.988        | 48.664      | -->
<!-- | # samples dev (%)  | 3.421 (2.38%) |3.136 (2.21%)  |1.122 (2.31%)| -->
<!-- | # controls samples |  91.784       | 90.244        | 33.572      | -->
<!-- | # controls dev  (%)|2.042 (**2.22%**)|1.696 (**1.88%**)|680 (**2.03%**)| -->
<!-- | # patients samples |  51.744       | 51.744        | 15.092      | -->
<!-- | # patients dev (%) | 1.379 (2.67%) | 1.440 (2.78%) | 442 (2.93%) | -->


<!-- |        MATCHED     | timepoint 1   | timepoint 2 | timepoint 3 | -->
<!-- | ----------------   |:-----------:  |:-----------:|:-----------:| -->
<!-- | # total samples    |  103.796      |101.024      | 30.184      | -->
<!-- | # samples dev (%)  |2.518 (2.42%)  |2.318 (2.27%)|760 (2.33%)  | -->
<!-- | # controls samples |  52.052       | 50.512      | 15.092      | -->
<!-- | # controls dev  (%)|1.111 (**2.13%**)|910 (**1.8%**)| 288 (**1.91%**)| -->
<!-- | # patients samples |  51.744       | 50.512     | 15.092      | -->
<!-- | # patients dev (%) |1.363 (2.63%)  |1.389 (2.75%)|   440 (2.92%)| -->

<!-- In the following, we chose to work with the matched dataset and the Zs derived from its lme model, providing a better statistical support for the analysis. -->

<!-- *** -->

<!-- We compute the number of deviant samples ($Z<-1.96$ and $Z>1.96$): -->

<!-- ```{r eval=FALSE, include=FALSE} -->
<!-- Z <- Zs_match %>%  -->
<!--   mutate(deviant = ifelse(z > -1.96 & z < 1.96, 0, z))%>%  -->
<!--   mutate(deviant = ifelse(z < -1.96, -1, deviant))%>%  -->
<!--   mutate(deviant = ifelse(z >  1.96, 1 , deviant))  -->
<!-- #t(table(Z$deviant, Z$timepoint)) -->
<!-- #round(t(table(Z$deviant==-1, Z$timepoint))*100/c(nrow(subset(Z, timepoint==1)),nrow(subset(Z, timepoint==2)),nrow(subset(Z, timepoint==3))),2) -->
<!-- ``` -->

<!-- |         | Infra-normal deviants|  Non deviants  | Supra-normal deviants | Deviants    |    -->
<!-- |---------|:--------------------:|:--------------:|:---------------------:|:-----------:| -->
<!-- |  tp 1   | 1.261 (1.21%)        |101.322 (97.62%)| 1.213 (1.17%)         |2.474 (2.38%)|  -->
<!-- |  tp 2   | 1.294 (1.28%)        |98.725 (97.72%) | 1.005 (0.99%)         | 2.299 (2.28)|  -->
<!-- |  tp 3   | 440 (1.46%)          |29.456 (97.59%) | 288 (0.95%)           |  728 (2.41%)|  -->
<!-- |  total  | 2.995 (1.27%)        |229.503 (97.66%)| 2.506 (1.07%)         |5.501 (2.34%)|  -->


<!-- We computed the number of subjects that are deviant at timepoint 1 and stay deviant in subsequent timepoints, for each region. A maximum of 6 subjects (1.78% of total subjects) fulfill that condition for any region. -->

<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- Z <- Zs_match %>%  -->
<!--   mutate(non_dev_tp1 = ifelse((z < -1.96 | z > 1.96)&timepoint==1, 1, 0), # Si se desvía vale 1 -->
<!--          dev_fup = ifelse((z < -1.96 | z > 1.96)&timepoint>1, 1, 0)) %>%  # Si se desvía vale 1 -->
<!--   mutate(cond=non_dev_tp1+dev_fup)%>% -->
<!--   group_by(region,subID) %>%  -->
<!--   summarise(mul = prod(cond)) %>%  -->
<!--   group_by(region) %>%  -->
<!--   summarise(sol = sum(mul)) %>%  -->
<!--   arrange(desc(sol)) -->
<!-- #length(unique(Zs_match$subID)) -->
<!-- #head(Z,3) -->
<!-- ``` -->

<!-- |                                   | Condition| -->
<!-- |-----------------------------------|:--------:| -->
<!-- |lh_cuneus_part2_thickness          |6 (1.78%) | -->
<!-- |lh_precentral_part5_thickness      |6 (1.78%) | -->
<!-- |lh_lateraloccipital_part5_thickness|5 (1.48%) | -->



<!-- We computed the number of subjects that are not deviant at timepoint 1 but become deviant in subsequent timepoints, for each region.  A maximum of 23 subjects (6.82% of total subjects) fulfill that condition for any region. -->


<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- Z <- Zs_match %>%  -->
<!--   mutate(non_dev_tp1 = ifelse((z > -1.96 | z < 1.96)&timepoint==1, 1, 0), # Si no se desvía vale 1 -->
<!--          dev_fup = ifelse((z < -1.96 | z > 1.96)&timepoint>1, 1, 0)) %>% # Si se desvía vale 1 -->
<!--   mutate(cond=non_dev_tp1+dev_fup)%>% -->
<!--   group_by(region,subID) %>%  -->
<!--   summarise(mul = prod(cond)) %>%  -->
<!--   group_by(region) %>%  -->
<!--   summarise(sol = sum(mul)) %>%  -->
<!--   arrange(desc(sol)) -->
<!-- #length(unique(Zs_match$subID)) -->
<!-- #head(Z,3) -->
<!-- ``` -->

<!-- |                                       | Condition| -->
<!-- |---------------------------------------|:--------:| -->
<!-- |lh_superiorfrontal_part9_thickness     |23 (6.82%)| -->
<!-- |rh_medialorbitofrontal_part1_thickness |22 (6.53%)| -->
<!-- |rh_temporalpole_part1_thickness        |22 (6.53%)| -->


<!-- *** -->

<!-- **1. Percentage of patients deviated from the normative range for any single cortical region** -->

<!-- + Timepoint 1: No more than 9.52% of patients deviated from the normative range for any single cortical region.  -->

<!-- + Timepoint 2: No more than 9.76% of patients deviated from the normative range for any single cortical region.  -->

<!-- + Timepoint 3: No more than 10.2% of patients deviated from the normative range for any single cortical region.  -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=TRUE} -->
<!-- # For 1 -->

<!-- for (tp in 1:3){ # for each timepoint -->
<!--   Z <- Zs_match %>%  -->
<!--     filter(group=="patient") %>%  -->
<!--     filter(timepoint==tp) %>%  -->
<!--     mutate(deviant = ifelse(z < -1.96 | z > 1.96, 1, 0))%>% -->
<!--     group_by(subID, region) %>%  -->
<!--     summarise(dev     = sum(deviant==1), -->
<!--               non_dev = sum(deviant==0)) %>%  -->
<!--     group_by(region)%>% -->
<!--     summarise(nreg_dev = sum(dev), -->
<!--               nreg_nondev = sum(non_dev))%>% -->
<!--     mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>%  -->
<!--     arrange(desc(perc_dev))  -->
<!--   #head(Z,3) -->
<!--   perc<-as.numeric(Z[1,"perc_dev"]) -->
<!--   cat("Timepoint", tp,":", perc,"%\n") -->
<!-- } -->
<!-- ``` -->

<!-- *** -->
<!-- **2. Most common regions with infra-normal deviations. Percentage of patients.** -->

<!-- + Timepoint 1: Infra-normal deviations in CT of subjects were most commonly located in *lh_superiortemporal_part2_thickness* cortices, although only 4.167% of patients showed significant deviations in these regions. -->

<!-- + Timepoint 2: Infra-normal deviations in CT of subjects were most commonly located in *lh_superiorfrontal_part9_thickness* cortices, although only 6.098% of patients showed significant deviations in these regions. -->

<!-- + Timepoint 3: Infra-normal deviations in CT of subjects were most commonly located in *lh_insula_part1_thickness* cortices, although only 8.163% of patients showed significant deviations in these regions. -->


<!-- \textcolor{red}{DUDA: sacar la región y su porcentaje en los pacientes? Lo que hice fue sacar la región de los sujetos y el porcentaje para esa región en los pacientes.} -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=TRUE} -->
<!-- # For 2 -->

<!-- for (tp in 1:3){ # for each timepoint -->
<!--   cat("Timepoint",tp,":\n") -->
<!--   Z_all <- Zs_match %>% -->
<!--     filter(timepoint==tp) %>% -->
<!--     mutate(deviant = ifelse(z < -1.96, 1, 0))%>% # Infra-normal -->
<!--     group_by(region) %>% -->
<!--     summarise(nreg_dev     = sum(deviant==1), -->
<!--               nreg_nondev  = sum(deviant==0)) %>% -->
<!--     mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>% -->
<!--     arrange(desc(perc_dev)) -->
<!--   #print(head(Z_all,5)) -->
<!--   reg <- as.character(Z_all[1,"region"]) -->
<!--   cat("Region in subjects:", reg,"\n") -->

<!--   Z_pat <- Zs_match %>% -->
<!--     filter(group=="patient") %>% # only for patients -->
<!--     filter(timepoint==tp) %>% -->
<!--     mutate(deviant = ifelse(z < -1.96, 1, 0))%>% # Infra-normal -->
<!--     group_by(region) %>% -->
<!--     summarise(nreg_dev     = sum(deviant==1), -->
<!--               nreg_nondev  = sum(deviant==0)) %>% -->
<!--     mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>% -->
<!--     arrange(desc(perc_dev)) -->
<!--   #print(head(Z_pat,5)) -->
<!--   perc <- as.numeric(subset(Z_pat, region==paste0(reg))[1,"perc_dev"]) -->
<!--   cat("Percentage in patients:",perc,"%\n\n") -->
<!-- } -->
<!-- ``` -->


<!-- *** -->
<!-- **3. Most common regions with supra-normal deviations. Percentage of individuals.** -->

<!-- + Timepoint 1: Supra-normal deviations in CT were most common in the *lh_superiorfrontal_part7_thickness* regions, 3.264% of individuals.  -->

<!-- + Timepoint 2: Supra-normal deviations in CT were most common in the *rh_medialorbitofrontal_part1_thickness* regions, 4.878% of individuals.  -->

<!-- + Timepoint 3: Supra-normal deviations in CT were most common in the *lh_inferiorparietal_part6_thickness* regions, 6.122% of individuals.  -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=TRUE} -->
<!-- # For 3 -->

<!-- for (tp in 1:3){ # for each timepoint -->
<!--   cat("Timepoint",tp,":\n") -->
<!--   Z_all <- Zs_match %>% -->
<!--     filter(timepoint==tp) %>% -->
<!--     mutate(deviant = ifelse(z > 1.96, 1, 0))%>% # Supra-normal -->
<!--     group_by(region) %>% -->
<!--     summarise(nreg_dev     = sum(deviant==1), -->
<!--               nreg_nondev  = sum(deviant==0)) %>% -->
<!--     mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>% -->
<!--     arrange(desc(perc_dev)) -->
<!--   #print(head(Z_all,5)) -->
<!--   reg  <- as.character(Z_all[1,"region"]) -->
<!--   perc <- as.numeric(Z_all[1,"perc_dev"]) -->
<!--   cat("Region:", reg,"with percentage: ",perc,"%\n\n") -->
<!-- } -->
<!-- ``` -->

<!-- *** -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=TRUE} -->
<!-- # For 4 and 5 -->

<!-- for (tp in 1:3){ # for each timepoint -->
<!--   cat("Timepoint",tp,":\n") -->

<!--   Z_pat <- Zs_match %>%  -->
<!--     filter(group=="patient") %>% # only for patients -->
<!--     filter(timepoint==tp)    %>% -->
<!--     mutate(deviant_infra = ifelse(z < -1.96, 1, 0))%>% # Infra-normal -->
<!--     mutate(deviant_supra = ifelse(z > 1.96, 1, 0)) %>% # Supra-normal -->
<!--     group_by(subID) %>% -->
<!--     summarise(nreg_dev_infra    = sum(deviant_infra==1), -->
<!--               nreg_dev_supra    = sum(deviant_supra==1))   %>%  -->
<!--     mutate(deviant_infra = ifelse(nreg_dev_infra>0, 1, 0), -->
<!--            deviant_supra = ifelse(nreg_dev_supra>0, 1, 0)) %>%  -->
<!--     summarise(pat_dev_infra    = sum(deviant_infra==1), -->
<!--               pat_nondev_infra = sum(deviant_infra==0), -->
<!--               pat_dev_supra    = sum(deviant_supra==1), -->
<!--               pat_nondev_supra = sum(deviant_supra==0)) %>%  -->
<!--     mutate(perc_dev_infra = round(100* pat_dev_infra/(pat_dev_infra+pat_nondev_infra),3), -->
<!--            perc_dev_supra = round(100* pat_dev_supra/(pat_dev_supra+pat_nondev_supra),3)) -->

<!--   perc_infra <- as.numeric(Z_pat[1,"perc_dev_infra"]) -->
<!--   perc_supra <- as.numeric(Z_pat[1,"perc_dev_supra"]) -->
<!--   cat("Patients: infra-normal->",perc_infra,"%; supra-normal->",perc_supra,"%\n") -->

<!--   Z_hc <- Zs_match %>%  -->
<!--     filter(group=="control") %>% # only for controls -->
<!--     filter(timepoint==tp)    %>% -->
<!--     mutate(deviant_infra = ifelse(z < -1.96, 1, 0))%>% # Infra-normal -->
<!--     mutate(deviant_supra = ifelse(z > 1.96, 1, 0)) %>% # Supra-normal -->
<!--     group_by(subID) %>% -->
<!--     summarise(nreg_dev_infra    = sum(deviant_infra==1), -->
<!--               nreg_dev_supra    = sum(deviant_supra==1))   %>%  -->
<!--     mutate(deviant_infra = ifelse(nreg_dev_infra>0, 1, 0), -->
<!--            deviant_supra = ifelse(nreg_dev_supra>0, 1, 0)) %>%  -->
<!--     summarise(hc_dev_infra    = sum(deviant_infra==1), -->
<!--               hc_nondev_infra = sum(deviant_infra==0), -->
<!--               hc_dev_supra    = sum(deviant_supra==1), -->
<!--               hc_nondev_supra = sum(deviant_supra==0)) %>%  -->
<!--     mutate(perc_dev_infra = round(100* hc_dev_infra/(hc_dev_infra+hc_nondev_infra),3), -->
<!--            perc_dev_supra = round(100* hc_dev_supra/(hc_dev_supra+hc_nondev_supra),3)) -->

<!--   perc_infra <- as.numeric(Z_hc[1,"perc_dev_infra"]) -->
<!--   perc_supra <- as.numeric(Z_hc[1,"perc_dev_supra"]) -->
<!--   cat("Healthy controls: infra-normal->",perc_infra,"%; supra-normal->",perc_supra,"%\n") -->
<!-- } -->
<!-- ``` -->

<!-- **4. Percentage of subjects with at least one region infra-normal deviated. Patients vs Healthy controls.** -->

<!-- + Timepoint 1: Infra-normal deviations for at least one region were evident in 60.714% of patients, whereas this was the case for 60.355% of healthy individuals. -->

<!-- + Timepoint 2: Infra-normal deviations for at least one region were evident in 63.415% of patients, whereas this was the case for 62.195% of healthy individuals. -->

<!-- + Timepoint 3: Infra-normal deviations for at least one region were evident in 77.551% of patients, whereas this was the case for only 73.469% of healthy individuals. -->


<!-- *** -->
<!-- **5. Percentage of subjects with at least one region supra-normal deviated. Patients vs Healthy controls.** -->

<!-- + Timepoint 1: Supra-normal deviations for at least one region were evident in 76.19% of patients and 71.598% of healthy individuals. -->

<!-- + Timepoint 2: Supra-normal deviations for at least one region were evident in 67.683% of patients and 69.512% of healthy individuals. -->

<!-- + Timepoint 3: Supra-normal deviations for at least one region were evident in 67.347% of patients and 81.633% of healthy individuals. -->

<!-- *** -->

<!-- ### Percentage of deviant subjects for number of regions -->

<!-- **Figura B del paper de Bethlehem.**  -->
<!-- En el eje de las x se representa el porcentaje de sujetos y en el eje y el número de regiones con el mismo ratio $\frac{|Z|>1.96}{|Z|<1.96}$. Se calcula para cada timepoint ($timepoint=1,2,3$). -->

<!-- ```{r Ratio, warning=F, message = F} -->
<!-- getStatistics(Zs_match,  "match") -->
<!-- getStatistics(Zs_NOmatch,"NOmatch") -->
<!-- ``` -->

<!-- Show the results from the global ratios obtained previously: -->

<!-- ### Match-it dataframe -->

<!-- ```{r show-png-prev_match, echo=FALSE} -->
<!-- img1 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/prevalence_wscores_1_match.png")), interpolate = FALSE) -->
<!-- img2 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/prevalence_wscores_2_match.png")), interpolate = FALSE) -->
<!-- img3 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/prevalence_wscores_3_match.png")), interpolate = FALSE) -->

<!-- grid.arrange(img1, img2, img3, ncol = 1, nrow=3)  -->
<!-- ``` -->


<!-- ### Raw dataframe -->


<!-- ```{r show-png-prev-NOmatch, echo=FALSE} -->
<!-- img1 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/prevalence_wscores_1_NOmatch.png")), interpolate = FALSE) -->
<!-- img2 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/prevalence_wscores_2_NOmatch.png")), interpolate = FALSE) -->
<!-- img3 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/prevalence_wscores_3_NOmatch.png")), interpolate = FALSE) -->

<!-- grid.arrange(img1, img2, img3, ncol = 1, nrow=3)  -->
<!-- ``` -->

<!-- ### Variance contribution across measures: -->

<!-- ```{r show-png-violin, echo=FALSE} -->
<!-- img1 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/violin_tp1.png")), interpolate = FALSE) -->
<!-- img2 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/violin_tp2.png")), interpolate = FALSE) -->
<!-- img3 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/violin_tp3.png")), interpolate = FALSE) -->

<!-- grid.arrange(img1, img2, img3, ncol = 1, nrow=3)  -->
<!-- ``` -->