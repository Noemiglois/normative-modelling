---
title: "Normative modeling in Schizophrenia - Analysis of the 34 regions parcellation"
author: "Noemi González Lois"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---


```{r setup I, include=F}
knitr::opts_chunk$set(
  include = TRUE,  
  echo=TRUE, 
  eval=TRUE, 
  warning=TRUE, 
  message = TRUE,
  cache = FALSE
)
```

### Packages and libraries

```{r, warning=F, message = F}

library("easypackages") # install.packages("easypackages")

# get a list of all the needed packages
list.of.packages <- c("viridis", "tidyverse", "MatchIt", "grid", "png", 
                      "gridExtra", "parallel", "nlme", "JMbayes", 
                      "BiocManager", "Biostrings", "lme4", "ggplot2", 
                      "Hmisc", "devtools", "longCombat", "neuroCombat", 
                      "tinytex", "knitr", "dplyr", "variancePartition",
                      "Rmisc", "doParallel")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
  if(length(new.packages)>0) { install.packages(new.packages)}

# load them all
libraries(list.of.packages)
ncores <- detectCores() # Number of cores available in pc
rm(list.of.packages, new.packages)
```



```{r, eval = FALSE, include = FALSE}
install_github("jcbeer/longCombat")
install_github("jfortin1/neuroCombatData")
install_github("jfortin1/neuroCombat_Rpackage")
BiocManager::install("Biostrings")
BiocManager::install("variancePartition")
install_version("dplyr", version = "1.0.5", repos = "http://cran.us.r-project.org")
tinytex::install_tinytex()

install.packages("dplyr")           # Install dplyr package
library("dplyr")                    # Load dplyr package
```

### Set working directory and load functions

```{r, warning=F, message = F}
setwd("/data_J/Scripts")
source("1_DataPreparation.R")
source("2_RegressionModel.R")
source("3_Statistics.R")
source("4_EDA.R")
```

# Data preparation

Options of DataPreparation function: 

* parc = "parc35" or "parc308" (whether to use the 34 regions parcellation or the 308 regions one)
* harmonization= "lC" or "nC" (whether to use lonCombat or NeuroCombat harmonization)
* match = T or F (whether to use match-it or not)

```{r, warning = F, message = F}
df_lC_NO_matched <- DataPreparation(parc = "parc35",
                                    harmonization = "lC",
                                    match = F)

df_lC_matched <- DataPreparation(parc = "parc35",
                                 harmonization = "lC",
                                 match = T)
```

\textcolor{red}{Warning}: Fewer control units than treated units; not all treated units will get a match.

Stack Overflow: This warning is because our treated group is larger than our control group (this happens in timepoint = 2). If you're doing 1:1 matching without replacement, all the control units will be used up before all the treated units get a match. **To remedy this, you need to match with replacement or think about whether you actually want to generalize to the control population and switch the labels on the treatment groups**. You can do this by creating a new variable, say notY, which is 1 - Y and then performing the same operations.

\textcolor{red}{The match in *sex variable* is not exact. Anyway, the match in \# patients, \# controls is done well (¿is it enough?)}

### NO MATCHED DATASET

|  NO MATCHED| timepoint 1| timepoint 2 | timepoint 3 |
| -----------|:----------:|:-----------:|:-----------:|
| # controls | 298        | 293         | 109         |
| # patients | 169        | 168         | 50          |


| Timepoint 1| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls | 131  | 167  |
| # patients |  38  | 131  |


| Timepoint 2| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls | 130  | 163  |
| # patients |  38  | 130  |

| Timepoint 3| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |  50  |  59  |
| # patients |   7  |  43  |

```{r, eval=FALSE, include=FALSE}
table(df_lC_NO_matched$dcode, df_lC_NO_matched$timepoint)

for (i in 1:3) {
  print(knitr::kable(table(dcode=df_lC_NO_matched$dcode, sex=df_lC_NO_matched$scode,
                           timepoint=df_lC_NO_matched$timepoint)[,,i]))
}
```


### MATCHED DATASET

Number of patients vs number of controls per timepoint is not exactly the same:


|  MATCHED   | timepoint 1| timepoint 2 | timepoint 3 |
| -----------|:----------:|:-----------:|:-----------:|
| # controls | 169        | 164         | 49          |
| # patients | 169        | 164         | 49          |

| Timepoint 1| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |  38  | 131  |
| # patients |  38  | 131  |


| Timepoint 2| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |  37  | 127  |
| # patients |  38  | 126  |


| Timepoint 3| sex 0| sex 1|
| -----------|:----:|:----:|
| # controls |   8  | 41   |
| # patients |   7  | 42   |

```{r, eval=FALSE, include=FALSE}

table(df_lC_matched$dcode, df_lC_matched$timepoint)

for (i in 1:3) {
  print(knitr::kable(table(dcode=df_lC_matched$dcode, sex=df_lC_matched$scode, 
                           timepoint=df_lC_matched$timepoint)[,,i]))
}
```

# Exploratory Data Analysis

Show relevant figures and analytics before and after data preparation. For example, age of controls vs age of patients in the raw df vs the match-it df:

## Matching ages:

```{r}
EDA_match_ages(df_lC_NO_matched,"NO match-it")

EDA_match_ages(df_lC_matched,"match-it")
```

# Linear Mixed Effects Model Regresion

Calling the *run_NormativeModel* function with different datasets. This will return the z scores (one for each region for each timepoint of each subject)

## NO Match-it dataframe (longCombat):

```{r}
Zs_NOmatch <- run_NormativeModel(df_lC_NO_matched,
                                 measure = "CT_freesurfer",
                                 parc = "parc35",
                                 match = "NOmatch",
                                 harmonization = "lC")
```

## Match-it dataframe (longCombat):

```{r}
Zs_match <- run_NormativeModel(df_lC_matched,
                               measure = "CT_freesurfer",
                               parc = "parc35",
                               match = "match",
                               harmonization = "lC")
```


## Match-it dataframe (Age*Diagnosis) BEFORE EXCLUDING DEVIANTS

```{r, message=F}
p_val <- run_AgeDiagnosisModel(df_lC_matched, 
                               measure = "CT_freesurfer",
                               Z = NULL, 
                               exclude_deviants = F)

p_val_FDR <- Apply_FDR_Correction(p_val)
```

```{r echo=FALSE, results='hold'}
cat("Without FDR correction:\n")
cat("Variable dcode has statistical significance for ", sum(p_val[,"dcode"]<0.05),"/",length(p_val[,"dcode"]), "regions\n")
cat("Variable dcode_age has statistical significance for ",sum(p_val[,"dcode_age"]<0.05),"/",length(p_val[,"dcode_age"]), "regions\n")
```

```{r echo=FALSE}
head(p_val, 4)  
```

```{r echo=FALSE, results='hold'}
cat("With FDR correction:\n")
cat("Variable dcode has statistical significance for ", sum(p_val_FDR[,"dcode"]<0.05),"/",length(p_val[,"dcode"]),"regions\n")
cat("Variable dcode_age has statistical significance for ",sum(p_val_FDR[,"dcode_age"]<0.05),"/",length(p_val[,"dcode_age"]),"regions")
```

```{r echo=FALSE}
head(p_val_FDR, 4)  
```

```{r, echo=FALSE}
# PLOT p-values
par(mfrow = c(2, 2), mai = c(0.9, 0.8, 0.2, 0.2))  # 2 rows and 2 columns
x1 <- p_val[,"dcode"]
x2 <- p_val_FDR[,"dcode"]
x3 <- p_val[,"dcode_age"]
x4 <- p_val_FDR[,"dcode_age"]

hist(x1, main="p-vals (dcode)", col="orange")
hist(x2, main="p-vals with FDR (dcode)", col="green")
hist(x3, main="p-vals (dcode_age)", col="orange")
hist(x4, main="p-vals with FDR (dcode_age)", col="green")
```


## Match-it dataframe (Age*Diagnosis) AFTER EXCLUDING DEVIANTS

```{r, message=F}
p_val <- run_AgeDiagnosisModel(df_lC_matched, 
                               measure = "CT_freesurfer",
                               Z = Zs_match, 
                               exclude_deviants = T)

p_val_FDR <- Apply_FDR_Correction(p_val)
```

```{r echo=FALSE, results='hold'}
cat("Without FDR correction:\n")
cat("Variable dcode has statistical significance for ",sum(p_val[,"dcode"]<0.05),"/",length(p_val[,"dcode"]),"regions\n")
cat("Variable dcode_age has statistical significance for ",sum(p_val[,"dcode_age"]<0.05),"/",length(p_val[,"dcode_age"]),"regions\n")
```

```{r echo=FALSE}
head(p_val, 4)  
```

```{r, echo=FALSE, results='hold'}
cat("With FDR correction:\n")
cat("Variable dcode has statistical significance for ", sum(p_val_FDR[,"dcode"]<0.05),"/",length(p_val[,"dcode"]),"regions\n")
cat("Variable dcode_age has statistical significance for ",sum(p_val_FDR[,"dcode_age"]<0.05),"/",length(p_val[,"dcode_age"]),"regions")
```

```{r echo=FALSE}
head(p_val_FDR, 4)  
```

```{r, echo=FALSE}
# PLOT p-values
par(mfrow = c(2, 2), mai = c(0.9, 0.8, 0.2, 0.2))  # 2 rows and 2 columns
x1 <- p_val[,"dcode"]
x2 <- p_val_FDR[,"dcode"]
x3 <- p_val[,"dcode_age"]
x4 <- p_val_FDR[,"dcode_age"]

hist(x1, main="p-vals (dcode)", col="orange")
hist(x2, main="p-vals with FDR (dcode)", col="green")
hist(x3, main="p-vals (dcode_age)", col="orange")
hist(x4, main="p-vals with FDR (dcode_age)", col="green")
```


# Analysis of z-scores and computation of global scores


```{r eval=FALSE, include=FALSE}
Z <- Zs_match %>% # change match / NOmatch
  mutate(deviant = ifelse(z > -1.96 & z < 1.96, 1, 0))

table(Z$timepoint) # 1st row
table(Z$deviant, Z$timepoint) # 1st row is 2nd row
t(table(Z$timepoint, Z$group))  # 1st row is 3rd row and 2nd row is 5th row
table(Z$deviant, Z$timepoint, Z$group)  # 1st row is 4th and 6th row

t(round(t(table(Z$deviant, Z$timepoint))*100/c(nrow(subset(Z, timepoint==1)),nrow(subset(Z, timepoint==2)),nrow(subset(Z, timepoint==3))),2)) # Percentages of the 2nd row

round(t(table(Z$deviant, Z$timepoint, Z$group)[1,1:3,])[1,1:3]*100/t(table(Z$timepoint, Z$group))[1,1:3],2) # controls, percentages of the 4th row

round(t(table(Z$deviant, Z$timepoint, Z$group)[1,1:3,])[2,1:3]*100/t(table(Z$timepoint, Z$group))[2,1:3],2) # pats, percentages of the 6th row
```

The following tables represent, **in terms of samples**, the number of deviations ($|Z|>1.96$). It is calculated for each timepoint ($timepoint=1,2,3$) and differentiated between controls and subjects.

|     NO MATCHED     | timepoint 1   | timepoint 2 | timepoint 3 |
| ----------------   |:-----------:  |:-----------:|:-----------:|
| # total samples    |   31.688      |   31.348    |  10.744     |
| # samples dev (%)  |  795 (2.51%)  |  696 (2.22%)|  275 (2.56%)|
| # controls samples |  20.264       |  19.924     |   7.412     |
| # controls dev  (%)|  450 (2.22%)  |  335 (1.68%)| 143 (1.93%) |
| # patients samples |  11.424       |   11.424    |  3.332      |
| # patients dev (%) |  345 (3.02%)  |  361 (3.16%)|  132 (3.96%)|



|     MATCHED        | timepoint 1   | timepoint 2   | timepoint 3 |
| ----------------   |:-----------:  |:-------------:|:-----------:|
| # total samples    |   22.916      |  22.304       |    6.664    |
| # samples dev (%)  |  617 (2.69%)  |    519 (2.33%)|  187 (2.81%)|
| # controls samples |  11.492       |  11.152       |  3.332      |
| # controls dev  (%)|   269 (2.34%) |  176 (1.58%)  |  71 (2.13%) |
| # patients samples |  11.424       |  11.152       |  3.332      |
| # patients dev (%) |  348 (3.05%)  |   343  (3.08%)|  116 (3.48%)|

In the following, we chose to work with the matched dataset and the Zs derived from its lme model, providing a better statistical support for the analysis.

***

We computed the number of deviant samples ($Z<-1.96$ and $Z>1.96$):

```{r, eval=FALSE, include=FALSE}
Z <- Zs_match %>%
  mutate(deviant = ifelse(z > -1.96 & z < 1.96, 0, z)) %>%
  mutate(deviant = ifelse(z < -1.96, -1, deviant)) %>%
  mutate(deviant = ifelse(z >  1.96, 1 , deviant))

t(table(Z$deviant, Z$timepoint)) # first 3x3 row-col
t(table(Z$deviant==1 | Z$deviant==-1, Z$timepoint)) #2nd col is --> last column
c(t(table(Z$deviant==-1))[2],t(table(Z$deviant==0))[2], t(table(Z$deviant==1))[2], 
  t(table(Z$deviant==1 | Z$deviant==-1))[2])  #last row

# Percentages 3x4
cbind(round(t(table(Z$deviant==-1, Z$timepoint))*100/c(nrow(subset(Z, timepoint==1)),nrow(subset(Z, timepoint==2)),nrow(subset(Z, timepoint==3))),2)[,2],
      round(t(table(Z$deviant==0, Z$timepoint))*100/c(nrow(subset(Z, timepoint==1)),nrow(subset(Z, timepoint==2)),nrow(subset(Z, timepoint==3))),2)[,2], 
      round(t(table(Z$deviant==1, Z$timepoint))*100/c(nrow(subset(Z, timepoint==1)),nrow(subset(Z, timepoint==2)),nrow(subset(Z, timepoint==3))),2)[,2],
round(t(table(Z$deviant==1 | Z$deviant==-1, Z$timepoint))*100/c(nrow(subset(Z, timepoint==1)),nrow(subset(Z, timepoint==2)),nrow(subset(Z, timepoint==3))),2)[,2])

# Percentages of the last row
round(c(t(table(Z$deviant==-1))[2],t(table(Z$deviant==0))[2], t(table(Z$deviant==1))[2], 
  t(table(Z$deviant==1 | Z$deviant==-1))[2])*100/sum(table(Z$deviant)),2)
```

|         | Infra-normal deviants|  Non deviants  | Supra-normal deviants | Deviants    |
|---------|:--------------------:|:--------------:|:---------------------:|:-----------:|
|  tp 1   |      339 (1.48%)     | 22.299 (97.31%)|     278 (1.21%)       |  617 (2.69%)|
|  tp 2   |      322 (1.44%)     | 21.785 (97.67%)|     197 (0.88%)       |  519 (2.33%)|
|  tp 3   |      133 (2.00%)     |  6.477 (97.19%)|      54 (0.81%)       |  187 (2.81%)|
|  total  |      794 (1.53%)     | 50.561 (97.45%)|     529 (1.02%)       |1.323 (2.55%)|


We computed the number of subjects that are **deviant at timepoint 1** and stay **deviant in subsequent timepoints**, for each region. A maximum of 5 subjects (1.48% of total subjects) fulfill that condition for any region.

```{r, message=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
Z <- Zs_match %>%
  mutate(dev = ifelse((z < -1.96 | z > 1.96), 1, 0)) %>%  # Si se desvía vale 1
  group_by(region, subID) %>%
  dplyr::summarise(mul = prod(dev)) %>% # Multiplicamos los dev de todos los tp de cada subject por cada región
  group_by(region) %>%           # Así, sólo valen distinto de 0 los que tienen todos los tp=1
  dplyr::summarise(sol = sum(mul)) %>%
  arrange(desc(sol))

round(Z[1,2]*100/length(unique(Zs_match$subID)),2) # Percentage in the text
head(Z,3)

```

|                                     | Condition|
|-------------------------------------|:--------:|
|rh_cuneus_CT_freesurfer              |    5     |
|lh_rostralmiddlefrontal_CT_freesurfer|    4     |
|lh_temporalpole_CT_freesurfer        |    4     |


We computed the number of subjects that are **not deviant at timepoint 1** but become **deviant in subsequent timepoints**, for each region.  A maximum of 20 subjects (5.93% of total subjects) fulfill that condition for any region.


```{r, message=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
# Los que cumplen la condición valen 1, el resto 0. Al multiplicar sólo dan 1 los que cumplen la condición.
Z <- Zs_match %>%
  mutate(non_dev_tp1 = ifelse((z > -1.96 | z < 1.96)&timepoint==1, 1, 0), # Si no se desvía en tp1 vale 1
         dev_fup = ifelse((z < -1.96 | z > 1.96)&timepoint>1, 1, 0)) %>%  # Si se desvía vale 1
  mutate(cond=non_dev_tp1+dev_fup)%>% # Sumamos ambas columnas para obtener una sólo
  group_by(region,subID) %>%
  dplyr::summarise(mul = prod(cond)) %>% # Multiplicamos todos los tp de cada subject para cada región
  group_by(region) %>%            # Así, sólo valen 1 los que tienen todos los tp=1
  dplyr::summarise(sol = sum(mul)) %>%
  arrange(desc(sol))

round(Z[1,2]*100/length(unique(Zs_match$subID)),2) # Percentage in the text
head(Z,3)
```

|                                       | Condition|
|---------------------------------------|:--------:|
|lh_lateraloccipital_CT_freesurfer      |   20     |
|rh_temporalpole_CT_freesurfer          |   18     |
|lh_posteriorcingulate_CT_freesurfer    |   18     |


***

**1. Percentage of patients deviated from the normative range for any single cortical region**

+ Timepoint 1: No more than 6.548% of patients deviated from the normative range for any single cortical region.

+ Timepoint 2: No more than 6.707% of patients deviated from the normative range for any single cortical region.

+ Timepoint 3: No more than 10.204% of patients deviated from the normative range for any single cortical region.


```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# For 1

for (tp in 1:3){ # for each timepoint
  Z <- Zs_match %>%
    filter(group=="patient") %>%
    filter(timepoint==tp) %>%
    mutate(dev = ifelse(z < -1.96 | z > 1.96, 1, 0))%>%
    group_by(region)%>%
    dplyr::summarise(nreg_dev = sum(dev==1),
              nreg_nondev = sum(dev==0))%>%
    mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>%
    arrange(desc(perc_dev))
  # head(Z,3)
  perc <- as.numeric(Z[1,"perc_dev"])
  cat("Timepoint", tp,":", perc,"%\n")
  #length(unique(Z$subID)) # Number of patients for each timepoint
}
```

***
**2. Most common regions with infra-normal deviations. Percentage of patients.**

+ Timepoint 1: Infra-normal deviations in CT of subjects were most commonly located in **rh_fusiform_CT_freesurfer** cortices, although only 1.786% of patients showed significant deviations in these regions.

+ Timepoint 2: Infra-normal deviations in CT of subjects were most commonly located in **rh_temporalpole_CT_freesurfer** cortices, although only 4.268% of patients showed significant deviations in these regions.

+ Timepoint 3: Infra-normal deviations in CT of subjects were most commonly located in **lh_fusiform_CT_freesurfer** cortices, although only 8.163% of patients showed significant deviations in these regions.

\textcolor{red}{DUDA: sacar la región y su porcentaje en los pacientes? Lo que hice fue sacar la región de los sujetos y el porcentaje para esa región concreta en los pacientes.}

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# For 2

for (tp in 1:3){ # for each timepoint
  cat("Timepoint",tp,":\n")
  Z_all <- Zs_match %>%
    #filter(group=="patient") %>% # only for patients ?????
    filter(timepoint==tp) %>%
    mutate(deviant = ifelse(z < -1.96, 1, 0)) %>% # Infra-normal
    group_by(region) %>%
    dplyr::summarise(nreg_dev     = sum(deviant==1),
              nreg_nondev  = sum(deviant==0)) %>%
    mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>%
    arrange(desc(perc_dev))
  #print(head(Z_all,5))
  reg <- as.character(Z_all[1,"region"])
  cat("Region in subjects:", reg,"\n")

  Z_pat <- Zs_match %>%
    filter(group=="patient") %>% # only for patients
    filter(timepoint==tp) %>%
    mutate(deviant = ifelse(z < -1.96, 1, 0))%>% # Infra-normal
    group_by(region) %>%
    dplyr::summarise(nreg_dev     = sum(deviant==1),
              nreg_nondev  = sum(deviant==0)) %>%
    mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>%
    arrange(desc(perc_dev))
  #print(head(Z_pat,5))
  perc <- as.numeric(subset(Z_pat, region==paste0(reg))[1,"perc_dev"])
  cat("Percentage in patients:",perc,"%\n\n")
}
```


***
**3. Most common regions with supra-normal deviations. Percentage of individuals.**

+ Timepoint 1: Supra-normal deviations in CT were most common in the **lh_lateraloccipital_CT_freesurfer** regions, 2.967% of individuals.

+ Timepoint 2: Supra-normal deviations in CT were most common in the **lh_lateraloccipital_CT_freesurfer** regions, 2.134% of individuals.

+ Timepoint 3: Supra-normal deviations in CT were most common in the **lh_parahippocampal_CT_freesurfer** regions, 3.061% of individuals.

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# For 3

for (tp in 1:3){ # for each timepoint
  cat("Timepoint",tp,":\n")
  Z_all <- Zs_match %>%
    filter(timepoint==tp) %>%
    mutate(deviant = ifelse(z > 1.96, 1, 0))%>% # Supra-normal
    group_by(region) %>%
    dplyr::summarise(nreg_dev     = sum(deviant==1),
              nreg_nondev  = sum(deviant==0)) %>%
    mutate(perc_dev = round(100* nreg_dev/(nreg_dev+nreg_nondev),3)) %>%
    arrange(desc(perc_dev))
  #print(head(Z_all,5))
  reg  <- as.character(Z_all[1,"region"])
  perc <- as.numeric(Z_all[1,"perc_dev"])
  cat("Region:", reg,"with percentage: ",perc,"%\n\n")
}
```

***

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# For 4 and 5

for (tp in 1:3){ # for each timepoint
  cat("\nTIMEPOINT",tp)

  Z_pat <- Zs_match %>%
    filter(group=="patient") %>% # only for patients
    filter(timepoint==tp)    %>%
    mutate(deviant_infra = ifelse(z < -1.96, 1, 0))%>% # Infra-normal
    mutate(deviant_supra = ifelse(z > 1.96, 1, 0)) %>% # Supra-normal
    group_by(subID) %>%
    dplyr::summarise(nreg_dev_infra    = sum(deviant_infra==1),   # At least one region deviated
              nreg_dev_supra    = sum(deviant_supra==1))   %>%
    mutate(deviant_infra = ifelse(nreg_dev_infra>0, 1, 0), # At least one region deviated
           deviant_supra = ifelse(nreg_dev_supra>0, 1, 0)) %>%
    dplyr::summarise(pat_dev_infra    = sum(deviant_infra==1),
              pat_nondev_infra = sum(deviant_infra==0),
              pat_dev_supra    = sum(deviant_supra==1),
              pat_nondev_supra = sum(deviant_supra==0)) %>%
    mutate(perc_dev_infra = round(100* pat_dev_infra/(pat_dev_infra+pat_nondev_infra),3),
           perc_dev_supra = round(100* pat_dev_supra/(pat_dev_supra+pat_nondev_supra),3))
  # porcentaje calculado con el total de pacientes para cada timepoint
  perc_infra_pac <- as.numeric(Z_pat[1,"perc_dev_infra"])
  perc_supra_pac <- as.numeric(Z_pat[1,"perc_dev_supra"])

  Z_hc <- Zs_match %>%
    filter(group=="control") %>% # only for controls
    filter(timepoint==tp)    %>%
    mutate(deviant_infra = ifelse(z < -1.96, 1, 0))%>% # Infra-normal
    mutate(deviant_supra = ifelse(z > 1.96, 1, 0)) %>% # Supra-normal
    group_by(subID) %>%
    dplyr::summarise(nreg_dev_infra    = sum(deviant_infra==1),
              nreg_dev_supra    = sum(deviant_supra==1))   %>%
    mutate(deviant_infra = ifelse(nreg_dev_infra>0, 1, 0),
           deviant_supra = ifelse(nreg_dev_supra>0, 1, 0)) %>%
    dplyr::summarise(hc_dev_infra    = sum(deviant_infra==1),
              hc_nondev_infra = sum(deviant_infra==0),
              hc_dev_supra    = sum(deviant_supra==1),
              hc_nondev_supra = sum(deviant_supra==0)) %>%
    mutate(perc_dev_infra = round(100* hc_dev_infra/(hc_dev_infra+hc_nondev_infra),3),
           perc_dev_supra = round(100* hc_dev_supra/(hc_dev_supra+hc_nondev_supra),3))
  # porcentaje calculado con el total de pacientes para cada timepoint
  perc_infra_hc <- as.numeric(Z_hc[1,"perc_dev_infra"])
  perc_supra_hc <- as.numeric(Z_hc[1,"perc_dev_supra"])
  
  cat('\nInfra-normal:')
  cat('\nPatients: ', perc_infra_pac,"%\n")
  cat('Healthy controls: ', perc_infra_hc,"%\n")
  cat('Supra-normal:')
  cat('\nPatients: ', perc_supra_pac,"%\n")
  cat('Healthy controls: ', perc_supra_hc,"%\n")
}
```

**4. Percentage of subjects with at least one region infra-normal deviated. Patients vs Healthy controls.**

+ Timepoint 1: Infra-normal deviations for at least one region were evident in 29.167% of patients, whereas this was the case for 26.036% of healthy individuals.

+ Timepoint 2: Infra-normal deviations for at least one region were evident in 35.366% of patients, whereas this was the case for 27.439% of healthy individuals.

+ Timepoint 3: Infra-normal deviations for at least one region were evident in 40.816% of patients, whereas this was the case for only 38.776% of healthy individuals.

***
**5. Percentage of subjects with at least one region supra-normal deviated. Patients vs Healthy controls.**

+ Timepoint 1: Supra-normal deviations for at least one region were evident in 32.143% of patients and 34.32% of healthy individuals.

+ Timepoint 2: Supra-normal deviations for at least one region were evident in 28.659% of patients and 29.878% of healthy individuals.

+ Timepoint 3: Supra-normal deviations for at least one region were evident in 30.612% of patients and 36.735% of healthy individuals.


***

### Percentage of deviant subjects for number of regions

**Figura B del paper de Bethlehem.**
En el eje de las x se representa el porcentaje de sujetos y en el eje y el número de regiones con el mismo ratio $\frac{|Z|>1.96}{|Z|<1.96}$. Se calcula para cada timepoint ($timepoint=1,2,3$).

```{r Ratio, warning=F, message = F}
getStatistics(Zs= Zs_match,  lab= "lC_match_parc35", parc= "parc35")
getStatistics(Zs= Zs_NOmatch, lab= "lC_NOmatch_parc35", parc= "parc35")
```

Show the results from the global ratios obtained:

## Match-it dataframe (longCombat):

```{r show-png-prev_match, echo=FALSE}
img1 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/prevalence_wscores_1_lC_match_parc35.png")), interpolate = FALSE)
img2 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/prevalence_wscores_2_lC_match_parc35.png")), interpolate = FALSE)
img3 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/prevalence_wscores_3_lC_match_parc35.png")), interpolate = FALSE)

grid.arrange(img1, img2, img3, ncol = 1, nrow=3)
```

## NO Match-it dataframe (longCombat):

```{r show-png-prev-NOmatch, echo=FALSE}
img1 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/prevalence_wscores_1_lC_NOmatch_parc35.png")), interpolate = FALSE)
img2 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/prevalence_wscores_2_lC_NOmatch_parc35.png")), interpolate = FALSE)
img3 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/prevalence_wscores_3_lC_NOmatch_parc35.png")), interpolate = FALSE)

grid.arrange(img1, img2, img3, ncol = 1, nrow=3)
```

### Variance contribution across measures:


```{r}
variancePartition(df = df_lC_NO_matched,
                  measure = "CT_freesurfer",
                  lab = "lC_NO_matched_parc35",
                  par = "parc35")

variancePartition(df = df_lC_matched,
                  measure = "CT_freesurfer",
                  lab = "lC_matched_parc35",
                  par = "parc35")
```

```{r show-png-violin, echo=FALSE}
img1 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/violin_tp1_lC_NO_matched_parc35.png")), interpolate = FALSE)
img2 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/violin_tp2_lC_NO_matched_parc35.png")), interpolate = FALSE)
img3 <- rasterGrob(as.raster(readPNG("/data_J/Results/Plots/parc35/violin_tp3_lC_NO_matched_parc35.png")), interpolate = FALSE)

grid.arrange(img1, img2, img3, ncol = 1, nrow=3)
```